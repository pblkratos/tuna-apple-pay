<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POC - Apple Pay via Tuna</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
        }

        .config-box {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 15px;
        }

        label strong {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            margin-top: 10px;
            padding: 12px 24px;
            background: #000;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
        }

        button:hover {
            background: #333;
        }

        #applePayButtonContainer {
            margin: 30px 0;
            min-height: 60px;
            display: block !important;
            padding: 20px;
            background: #fff;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            position: relative;
        }

        /* Garantir que o bot√£o Apple Pay seja vis√≠vel */
        #applePayButtonContainer apple-pay-button {
            display: inline-block !important;
            visibility: visible !important;
            width: 100% !important;
            max-width: 300px !important;
            min-height: 44px !important;
            height: auto !important;
            -webkit-appearance: none !important;
            opacity: 1 !important;
        }

        /* Fallback para quando o bot√£o n√£o renderizar */
        #applePayButtonContainer:empty::after {
            content: "Aguardando bot√£o Apple Pay...";
            color: #999;
            font-size: 14px;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .loading {
            text-align: center;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçé Apple Pay - Tuna POC</h1>

        <div class="config-box">
            <label>
                <strong>API URL:</strong>
                <input type="text" id="apiUrl" value="http://multipedidos.beta">
            </label>
            <label>
                <strong>Restaurant ID:</strong>
                <input type="number" id="restaurantId" value="1">
            </label>
            <label>
                <strong>Ambiente:</strong>
                <select id="tunaEnvironment">
                    <option value="production">Produ√ß√£o</option>
                    <option value="sandbox">Sandbox</option>
                </select>
            </label>
            <label style="margin-top: 10px;">
                <input type="checkbox" id="useMockSession" style="width: auto; margin-right: 8px;">
                <strong>Usar Session Mock</strong>
            </label>
            <button onclick="initTuna()">Carregar Apple Pay</button>
        </div>

        <div id="applePayButtonContainer">
            <div class="loading">Clique em "Carregar Apple Pay" para iniciar</div>
        </div>

        <div id="status" class="status"></div>
    </div>

    <!-- Tuna SDK v2 -->
    <script src="https://storage.googleapis.com/tuna-statics/tuna-v2.js"></script>

    <script>
        const MOCK_SESSION_ID = 'sXvHXB2y7DEtt4QBYfbmNLh7TBfBlB5SldrPmTFTrMVCdEGO3yeGl62DcHyRrFDnz89SPXB6HaOuY0xh92BcUmdZ31nsnUv6b0GVyBYENNZ4Y91T';

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        async function getSessionId(apiUrl, restaurantId) {
            const response = await fetch(`${apiUrl}/restaurant/tuna/session`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ restaurantId: parseInt(restaurantId) })
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP ${response.status}`);
            }

            const data = await response.json();
            if (!data.sessionId) {
                throw new Error('SessionId n√£o encontrado na resposta');
            }

            return data.sessionId;
        }

        function validateButton() {
            const container = document.getElementById('applePayButtonContainer');
            
            // Verificar se h√° qualquer elemento filho
            console.log('=== VALIDA√á√ÉO DO BOT√ÉO ===');
            console.log('Container HTML:', container.innerHTML);
            console.log('N√∫mero de filhos:', container.children.length);
            
            // Procurar por apple-pay-button
            const applePayButton = container.querySelector('apple-pay-button');
            console.log('apple-pay-button encontrado?', !!applePayButton);
            
            // Procurar por qualquer bot√£o
            const anyButton = container.querySelector('button');
            console.log('button encontrado?', !!anyButton);
            
            // Listar todos os elementos filhos
            Array.from(container.children).forEach((child, index) => {
                console.log(`Filho ${index}:`, child.tagName, child.className);
            });
            
            if (applePayButton) {
                const style = window.getComputedStyle(applePayButton);
                const hasSize = parseFloat(style.width) > 0 && parseFloat(style.height) > 0;
                const isVisible = style.display !== 'none' && style.visibility !== 'hidden';
                
                console.log('Estilos do bot√£o:', {
                    width: style.width,
                    height: style.height,
                    display: style.display,
                    visibility: style.visibility,
                    opacity: style.opacity,
                    hasSize,
                    isVisible
                });

                // For√ßar visibilidade se necess√°rio
                if (!hasSize || !isVisible) {
                    applePayButton.style.display = 'inline-block';
                    applePayButton.style.visibility = 'visible';
                    applePayButton.style.width = '100%';
                    applePayButton.style.maxWidth = '300px';
                    applePayButton.style.minHeight = '44px';
                    console.log('Estilos for√ßados aplicados');
                }

                if (hasSize && isVisible) {
                    showStatus('‚úÖ Bot√£o Apple Pay carregado e vis√≠vel!', 'success');
                    return true;
                } else {
                    showStatus('‚ö†Ô∏è Bot√£o encontrado mas sem dimens√µes vis√≠veis', 'error');
                    return false;
                }
            } else {
                showStatus('‚ùå Bot√£o n√£o foi renderizado', 'error');
                return false;
            }
        }

        async function initTuna() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const restaurantId = document.getElementById('restaurantId').value.trim();
            const tunaEnvironment = document.getElementById('tunaEnvironment').value;
            const useMockSession = document.getElementById('useMockSession').checked;

            if (!useMockSession && (!apiUrl || !restaurantId)) {
                showStatus('‚ùå Preencha API URL e Restaurant ID', 'error');
                return;
            }

            const container = document.getElementById('applePayButtonContainer');
            container.innerHTML = '<div class="loading">Carregando...</div>';
            showStatus('', '');

            try {
                // Obter sessionId
                let sessionId;
                if (useMockSession) {
                    sessionId = MOCK_SESSION_ID;
                    console.log('Usando sessionId mock');
                } else {
                    sessionId = await getSessionId(apiUrl, restaurantId);
                    console.log('SessionId obtido:', sessionId);
                }

                // Verificar SDK
                if (typeof Tuna === 'undefined') {
                    throw new Error('Tuna SDK n√£o carregado');
                }

                // Inicializar Tuna
                let tuna;
                try {
                    tuna = Tuna(sessionId, tunaEnvironment);
                } catch (e) {
                    tuna = Tuna(sessionId);
                }

                if (typeof tuna.useApplePay !== 'function') {
                    throw new Error('M√©todo useApplePay n√£o encontrado');
                }

                // Limpar container mas manter estrutura
                container.innerHTML = '';
                console.log('Container limpo, pronto para renderizar bot√£o');

                // Configurar Apple Pay
                const applePaySettings = {
                    buttom: {
                        selector: '#applePayButtonContainer'
                    },
                    cart: {
                        lineItems: [{
                            label: 'Produto de Teste',
                            amount: 1.00
                        }],
                        total: {
                            label: 'Total',
                            amount: 1.00
                        }
                    },
                    merchantId: 'BCR2DN6TR7QYLIKK',
                    displayName: 'Teste POC Tuna',
                    applePayCallback: function(payload) {
                        console.log('Apple Pay payload:', payload);
                        showStatus('‚úÖ Pagamento processado!', 'success');
                        return Promise.resolve();
                    }
                };

                console.log('Configura√ß√£o Apple Pay:', JSON.stringify(applePaySettings, null, 2));

                // Renderizar bot√£o
                console.log('Chamando tuna.useApplePay...');
                const isReady = await tuna.useApplePay(applePaySettings);
                console.log('useApplePay retornou:', isReady);
                
                if (isReady) {
                    console.log('Apple Pay est√° pronto, aguardando renderiza√ß√£o...');
                    
                    // Verificar imediatamente
                    validateButton();
                    
                    // Aguardar renderiza√ß√£o do bot√£o (web components podem demorar)
                    setTimeout(() => {
                        console.log('Verifica√ß√£o ap√≥s 500ms');
                        validateButton();
                    }, 500);

                    // Verificar novamente ap√≥s 1 segundo
                    setTimeout(() => {
                        console.log('Verifica√ß√£o ap√≥s 1.5s');
                        validateButton();
                    }, 1500);

                    // Verificar novamente ap√≥s 3 segundos
                    setTimeout(() => {
                        console.log('Verifica√ß√£o ap√≥s 3s');
                        validateButton();
                    }, 3000);
                } else {
                    console.log('Apple Pay n√£o est√° dispon√≠vel');
                    showStatus('‚ùå Apple Pay n√£o est√° dispon√≠vel neste dispositivo', 'error');
                }

            } catch (error) {
                console.error('Erro:', error);
                showStatus(`‚ùå Erro: ${error.message}`, 'error');
                container.innerHTML = `<div class="loading" style="color: red;">Erro: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
